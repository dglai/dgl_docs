<!DOCTYPE html>

<html class="writer-html5" data-content_root="../../" lang="en">
<head>
<meta charset="utf-8"/><meta content="width=device-width, initial-scale=1" name="viewport"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Stochastic Training of GNN for Link Prediction ‚Äî DGL 1.1.3 documentation</title>
<link href="../../_static/pygments.css?v=80d5e7a1" rel="stylesheet" type="text/css"/>
<link href="../../_static/css/theme.css?v=19f00094" rel="stylesheet" type="text/css"/>
<link href="../../_static/graphviz.css?v=fd3f3429" rel="stylesheet" type="text/css"/>
<link href="../../_static/copybutton.css?v=76b2166b" rel="stylesheet" type="text/css"/>
<link href="../../_static/sg_gallery.css?v=d2d258e8" rel="stylesheet" type="text/css"/>
<link href="../../_static/sg_gallery-binder.css?v=f4aeca0c" rel="stylesheet" type="text/css"/>
<link href="../../_static/sg_gallery-dataframe.css?v=2082cf3c" rel="stylesheet" type="text/css"/>
<link href="../../_static/sg_gallery-rendered-html.css?v=1277b6f3" rel="stylesheet" type="text/css"/>
<link href="../../_static/css/custom.css?v=0bf289b5" rel="stylesheet" type="text/css"/>
<!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
<script src="../../_static/jquery.js?v=5d32c60e"></script>
<script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
<script src="../../_static/documentation_options.js?v=cb7bf70b"></script>
<script src="../../_static/doctools.js?v=9a2dae69"></script>
<script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
<script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
<script src="../../_static/copybutton.js?v=ccdb6887"></script>
<script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
<script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
<script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
<script src="../../_static/js/theme.js"></script>
<link href="../../genindex.html" rel="index" title="Index"/>
<link href="../../search.html" rel="search" title="Search"/>
<link href="L4_message_passing.html" rel="next" title="Writing GNN Modules for Stochastic GNN Training"/>
<link href="L1_large_node_classification.html" rel="prev" title="Training GNN with Neighbor Sampling for Node Classification"/>
</head>
<body class="wy-body-for-nav">
<div class="wy-grid-for-nav">
<nav class="wy-nav-side" data-toggle="wy-nav-shift">
<div class="wy-side-scroll">
<div class="wy-side-nav-search">
<a class="icon icon-home" href="../../index.html">
            DGL
          </a>
<div class="version">
                1.1.3
              </div>
<div role="search">
<form action="../../search.html" class="wy-form" id="rtd-search-form" method="get">
<input aria-label="Search docs" name="q" placeholder="Search docs" type="text"/>
<input name="check_keywords" type="hidden" value="yes"/>
<input name="area" type="hidden" value="default"/>
</form>
</div>
</div><div aria-label="Navigation menu" class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation">
<p class="caption" role="heading"><span class="caption-text">Get Started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install/index.html">Install and Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../blitz/index.html">A Blitz Introduction to DGL</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Advanced Materials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../guide/index.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide_cn/index.html">Áî®Êà∑ÊåáÂçó</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../guide_ko/index.html">ÏÇ¨Ïö©Ïûê Í∞ÄÏù¥Îìú</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../notebooks/sparse/index.html">üÜï Tutorials: dgl.sparse</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Stochastic Training of GNNs</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="L0_neighbor_sampling_overview.html">Introduction of Neighbor Sampling for GNN Training</a></li>
<li class="toctree-l2"><a class="reference internal" href="L1_large_node_classification.html">Training GNN with Neighbor Sampling for Node Classification</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Stochastic Training of GNN for Link Prediction</a></li>
<li class="toctree-l2"><a class="reference internal" href="L4_message_passing.html">Writing GNN Modules for Stochastic GNN Training</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../cpu/index.html">Training on CPUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../multi/index.html">Training on Multiple GPUs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../dist/index.html">Distributed training</a></li>
<li class="toctree-l1"><a class="reference internal" href="../models/index.html">Paper Study with DGL</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../api/python/dgl.html">dgl</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/python/dgl.data.html">dgl.data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/python/dgl.dataloading.html">dgl.dataloading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/python/dgl.DGLGraph.html">dgl.DGLGraph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/python/dgl.distributed.html">dgl.distributed</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/python/dgl.function.html">dgl.function</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/python/dgl.geometry.html">dgl.geometry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/python/nn-pytorch.html">dgl.nn (PyTorch)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/python/nn-tensorflow.html">dgl.nn (TensorFlow)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/python/nn-mxnet.html">dgl.nn (MXNet)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/python/nn.functional.html">dgl.nn.functional</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/python/dgl.ops.html">dgl.ops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/python/dgl.optim.html">dgl.optim</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/python/dgl.sampling.html">dgl.sampling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/python/dgl.sparse_v0.html">üÜï dgl.sparse</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/python/dgl.multiprocessing.html">dgl.multiprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/python/transforms.html">dgl.transforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/python/udf.html">User-defined Functions</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../contribute.html">Contribute to DGL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developer/ffi.html">DGL Foreign Function Interface (FFI)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../performance.html">Performance Benchmarks</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Misc</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">Frequently Asked Questions (FAQ)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../env_var.html">Environment Variables</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../resources.html">Resources</a></li>
</ul>
</div>
</div>
</nav>
<section class="wy-nav-content-wrap" data-toggle="wy-nav-shift"><nav aria-label="Mobile navigation menu" class="wy-nav-top">
<i class="fa fa-bars" data-toggle="wy-nav-top"></i>
<a href="../../index.html">DGL</a>
</nav>
<div class="wy-nav-content">
<div class="rst-content">
<div aria-label="Page navigation" role="navigation">
<ul class="wy-breadcrumbs">
<li><a aria-label="Home" class="icon icon-home" href="../../index.html"></a></li>
<li class="breadcrumb-item"><a href="index.html">Stochastic Training of GNNs</a></li>
<li class="breadcrumb-item active">Stochastic Training of GNN for Link Prediction</li>
<li class="wy-breadcrumbs-aside">
<a href="../../_sources/tutorials/large/L2_large_link_prediction.rst.txt" rel="nofollow"> View page source</a>
</li>
</ul>
<hr/>
</div>
<div class="document" itemscope="itemscope" itemtype="http://schema.org/Article" role="main">
<div itemprop="articleBody">
<div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p><a class="reference internal" href="#sphx-glr-download-tutorials-large-l2-large-link-prediction-py"><span class="std std-ref">Go to the end</span></a>
to download the full example code.</p>
</div>
<section class="sphx-glr-example-title" id="stochastic-training-of-gnn-for-link-prediction">
<span id="sphx-glr-tutorials-large-l2-large-link-prediction-py"></span><h1>Stochastic Training of GNN for Link Prediction<a class="headerlink" href="#stochastic-training-of-gnn-for-link-prediction" title="Link to this heading">ÔÉÅ</a></h1>
<p>This tutorial will show how to train a multi-layer GraphSAGE for link
prediction on <code class="docutils literal notranslate"><span class="pre">ogbn-arxiv</span></code> provided by <a class="reference external" href="https://ogb.stanford.edu/">Open Graph Benchmark
(OGB)</a>. The dataset
contains around 170 thousand nodes and 1 million edges.</p>
<p>By the end of this tutorial, you will be able to</p>
<ul class="simple">
<li><p>Train a GNN model for link prediction on a single GPU with DGL‚Äôs
neighbor sampling components.</p></li>
</ul>
<p>This tutorial assumes that you have read the <a class="reference internal" href="L0_neighbor_sampling_overview.html"><span class="doc">Introduction of Neighbor
Sampling for GNN Training</span></a> and <a class="reference internal" href="L1_large_node_classification.html"><span class="doc">Neighbor
Sampling for Node Classification</span></a>.</p>
<section id="link-prediction-overview">
<h2>Link Prediction Overview<a class="headerlink" href="#link-prediction-overview" title="Link to this heading">ÔÉÅ</a></h2>
<p>Link prediction requires the model to predict the probability of
existence of an edge. This tutorial does so by computing a dot product
between the representations of both incident nodes.</p>
<div class="math notranslate nohighlight">
\[\hat{y}_{u\sim v} = \sigma(h_u^T h_v)\]</div>
<p>It then minimizes the following binary cross entropy loss.</p>
<div class="math notranslate nohighlight">
\[\mathcal{L} = -\sum_{u\sim v\in \mathcal{D}}\left( y_{u\sim v}\log(\hat{y}_{u\sim v}) + (1-y_{u\sim v})\log(1-\hat{y}_{u\sim v})) \right)\]</div>
<p>This is identical to the link prediction formulation in <a class="reference internal" href="../blitz/4_link_predict.html"><span class="doc">the previous
tutorial on link prediction</span></a>.</p>
</section>
<section id="loading-dataset">
<h2>Loading Dataset<a class="headerlink" href="#loading-dataset" title="Link to this heading">ÔÉÅ</a></h2>
<p>This tutorial loads the dataset from the <code class="docutils literal notranslate"><span class="pre">ogb</span></code> package as in the
<a class="reference internal" href="L1_large_node_classification.html"><span class="doc">previous tutorial</span></a>.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<a class="sphx-glr-backref-module-os sphx-glr-backref-type-py-data" href="https://docs.python.org/3/library/os.html#os.environ" title="os.environ"><span class="n">os</span><span class="o">.</span><span class="n">environ</span></a><span class="p">[</span><span class="s2">"DGLBACKEND"</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"pytorch"</span>
<span class="kn">import</span> <span class="nn">dgl</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">ogb.nodeproppred</span> <span class="kn">import</span> <span class="n">DglNodePropPredDataset</span>

<span class="n">dataset</span> <span class="o">=</span> <span class="n">DglNodePropPredDataset</span><span class="p">(</span><span class="s2">"ogbn-arxiv"</span><span class="p">)</span>
<a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str"><span class="n">device</span></a> <span class="o">=</span> <span class="s2">"cpu"</span>  <span class="c1"># change to 'cuda' for GPU</span>

<span class="n">graph</span><span class="p">,</span> <span class="n">node_labels</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="c1"># Add reverse edges since ogbn-arxiv is unidirectional.</span>
<span class="n">graph</span> <span class="o">=</span> <span class="n">dgl</span><span class="o">.</span><span class="n">add_reverse_edges</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">node_labels</span><span class="p">)</span>

<span class="n">node_features</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">ndata</span><span class="p">[</span><span class="s2">"feat"</span><span class="p">]</span>
<span class="n">node_labels</span> <span class="o">=</span> <span class="n">node_labels</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
<a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/functions.html#int" title="builtins.int"><span class="n">num_features</span></a> <span class="o">=</span> <span class="n">node_features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/functions.html#int" title="builtins.int"><span class="n">num_classes</span></a> <span class="o">=</span> <span class="p">(</span><span class="n">node_labels</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Number of classes:"</span><span class="p">,</span> <a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/functions.html#int" title="builtins.int"><span class="n">num_classes</span></a><span class="p">)</span>

<a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict"><span class="n">idx_split</span></a> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">get_idx_split</span><span class="p">()</span>
<span class="n">train_nids</span> <span class="o">=</span> <a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict"><span class="n">idx_split</span></a><span class="p">[</span><span class="s2">"train"</span><span class="p">]</span>
<span class="n">valid_nids</span> <span class="o">=</span> <a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict"><span class="n">idx_split</span></a><span class="p">[</span><span class="s2">"valid"</span><span class="p">]</span>
<span class="n">test_nids</span> <span class="o">=</span> <a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/stdtypes.html#dict" title="builtins.dict"><span class="n">idx_split</span></a><span class="p">[</span><span class="s2">"test"</span><span class="p">]</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Graph(num_nodes=169343, num_edges=2332486,
      ndata_schemes={'year': Scheme(shape=(1,), dtype=torch.int64), 'feat': Scheme(shape=(128,), dtype=torch.float32)}
      edata_schemes={})
tensor([[ 4],
        [ 5],
        [28],
        ...,
        [10],
        [ 4],
        [ 1]])
Number of classes: 40
</pre></div>
</div>
</section>
<section id="defining-neighbor-sampler-and-data-loader-in-dgl">
<h2>Defining Neighbor Sampler and Data Loader in DGL<a class="headerlink" href="#defining-neighbor-sampler-and-data-loader-in-dgl" title="Link to this heading">ÔÉÅ</a></h2>
<p>Different from the <a class="reference internal" href="../blitz/4_link_predict.html"><span class="doc">link prediction tutorial for full
graph</span></a>, a common practice to train GNN on large graphs is
to iterate over the edges
in minibatches, since computing the probability of all edges is usually
impossible. For each minibatch of edges, you compute the output
representation of their incident nodes using neighbor sampling and GNN,
in a similar fashion introduced in the <a class="reference internal" href="L1_large_node_classification.html"><span class="doc">large-scale node classification
tutorial</span></a>.</p>
<p>DGL provides <code class="docutils literal notranslate"><span class="pre">dgl.dataloading.as_edge_prediction_sampler</span></code> to
iterate over edges for edge classification or link prediction tasks.</p>
<p>To perform link prediction, you need to specify a negative sampler. DGL
provides builtin negative samplers such as
<code class="docutils literal notranslate"><span class="pre">dgl.dataloading.negative_sampler.Uniform</span></code>.  Here this tutorial uniformly
draws 5 negative examples per positive example.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">negative_sampler</span> <span class="o">=</span> <span class="n">dgl</span><span class="o">.</span><span class="n">dataloading</span><span class="o">.</span><span class="n">negative_sampler</span><span class="o">.</span><span class="n">Uniform</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<p>After defining the negative sampler, one can then define the edge data
loader with neighbor sampling.  To create an <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code> for
link prediction, provide a neighbor sampler object as well as the negative
sampler object created above.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">sampler</span> <span class="o">=</span> <span class="n">dgl</span><span class="o">.</span><span class="n">dataloading</span><span class="o">.</span><span class="n">NeighborSampler</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
<span class="n">sampler</span> <span class="o">=</span> <span class="n">dgl</span><span class="o">.</span><span class="n">dataloading</span><span class="o">.</span><span class="n">as_edge_prediction_sampler</span><span class="p">(</span>
    <span class="n">sampler</span><span class="p">,</span> <span class="n">negative_sampler</span><span class="o">=</span><span class="n">negative_sampler</span>
<span class="p">)</span>
<span class="n">train_dataloader</span> <span class="o">=</span> <a class="sphx-glr-backref-module-typing sphx-glr-backref-type-py-class" href="https://docs.python.org/3/library/typing.html#typing.Generic" title="typing.Generic"><span class="n">dgl</span><span class="o">.</span><span class="n">dataloading</span><span class="o">.</span><span class="n">DataLoader</span></a><span class="p">(</span>
    <span class="c1"># The following arguments are specific to DataLoader.</span>
    <span class="n">graph</span><span class="p">,</span>  <span class="c1"># The graph</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">num_edges</span><span class="p">()),</span>  <span class="c1"># The edges to iterate over</span>
    <span class="n">sampler</span><span class="p">,</span>  <span class="c1"># The neighbor sampler</span>
    <a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str"><span class="n">device</span></a><span class="o">=</span><a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str"><span class="n">device</span></a><span class="p">,</span>  <span class="c1"># Put the MFGs on CPU or GPU</span>
    <span class="c1"># The following arguments are inherited from PyTorch DataLoader.</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>  <span class="c1"># Batch size</span>
    <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Whether to shuffle the nodes for every epoch</span>
    <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Whether to drop the last incomplete batch</span>
    <span class="n">num_workers</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>  <span class="c1"># Number of sampler processes</span>
<span class="p">)</span>
</pre></div>
</div>
<p>You can peek one minibatch from <code class="docutils literal notranslate"><span class="pre">train_dataloader</span></code> and see what it
will give you.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">input_nodes</span><span class="p">,</span> <span class="n">pos_graph</span><span class="p">,</span> <span class="n">neg_graph</span><span class="p">,</span> <a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list"><span class="n">mfgs</span></a> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Number of input nodes:"</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_nodes</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="s2">"Positive graph # nodes:"</span><span class="p">,</span>
    <span class="n">pos_graph</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">(),</span>
    <span class="s2">"# edges:"</span><span class="p">,</span>
    <span class="n">pos_graph</span><span class="o">.</span><span class="n">num_edges</span><span class="p">(),</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="s2">"Negative graph # nodes:"</span><span class="p">,</span>
    <span class="n">neg_graph</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">(),</span>
    <span class="s2">"# edges:"</span><span class="p">,</span>
    <span class="n">neg_graph</span><span class="o">.</span><span class="n">num_edges</span><span class="p">(),</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list"><span class="n">mfgs</span></a><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>/home/ubuntu/regression_test/dgl/python/dgl/dataloading/dataloader.py:1149: DGLWarning: Dataloader CPU affinity opt is not enabled, consider switching it on (see enable_cpu_affinity() or CPU best practices for DGL [https://docs.dgl.ai/tutorials/cpu/cpu_best_practises.html])
  dgl_warning(
Number of input nodes: 56789
Positive graph # nodes: 6909 # edges: 1024
Negative graph # nodes: 6909 # edges: 5120
[Block(num_src_nodes=56789, num_dst_nodes=23702, num_edges=88047), Block(num_src_nodes=23702, num_dst_nodes=6909, num_edges=23981)]
</pre></div>
</div>
<p>The example minibatch consists of four elements.</p>
<p>The first element is an ID tensor for the input nodes, i.e., nodes
whose input features are needed on the first GNN layer for this minibatch.</p>
<p>The second element and the third element are the positive graph and the
negative graph for this minibatch.
The concept of positive and negative graphs have been introduced in the
<a class="reference internal" href="../blitz/4_link_predict.html"><span class="doc">full-graph link prediction tutorial</span></a>.  In minibatch
training, the positive graph and the negative graph only contain nodes
necessary for computing the pair-wise scores of positive and negative examples
in the current minibatch.</p>
<p>The last element is a list of <a class="reference internal" href="L0_neighbor_sampling_overview.html"><span class="doc">MFGs</span></a>
storing the computation dependencies for each GNN layer.
The MFGs are used to compute the GNN outputs of the nodes
involved in positive/negative graph.</p>
</section>
<section id="defining-model-for-node-representation">
<h2>Defining Model for Node Representation<a class="headerlink" href="#defining-model-for-node-representation" title="Link to this heading">ÔÉÅ</a></h2>
<p>The model is almost identical to the one in the <a class="reference internal" href="L1_large_node_classification.html"><span class="doc">node classification
tutorial</span></a>. The only difference is
that since you are doing link prediction, the output dimension will not
be the number of classes in the dataset.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<span class="kn">from</span> <span class="nn">dgl.nn</span> <span class="kn">import</span> <span class="n">SAGEConv</span>


<span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_feats</span><span class="p">,</span> <span class="n">h_feats</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">SAGEConv</span><span class="p">(</span><span class="n">in_feats</span><span class="p">,</span> <span class="n">h_feats</span><span class="p">,</span> <span class="n">aggregator_type</span><span class="o">=</span><span class="s2">"mean"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">SAGEConv</span><span class="p">(</span><span class="n">h_feats</span><span class="p">,</span> <span class="n">h_feats</span><span class="p">,</span> <span class="n">aggregator_type</span><span class="o">=</span><span class="s2">"mean"</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">h_feats</span> <span class="o">=</span> <span class="n">h_feats</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list"><span class="n">mfgs</span></a><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">h_dst</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span> <a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list"><span class="n">mfgs</span></a><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">num_dst_nodes</span><span class="p">()]</span>
        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv1</span><span class="p">(</span><a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list"><span class="n">mfgs</span></a><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">h_dst</span><span class="p">))</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
        <span class="n">h_dst</span> <span class="o">=</span> <span class="n">h</span><span class="p">[:</span> <a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list"><span class="n">mfgs</span></a><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">num_dst_nodes</span><span class="p">()]</span>
        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv2</span><span class="p">(</span><a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list"><span class="n">mfgs</span></a><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">h_dst</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">h</span>


<span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/functions.html#int" title="builtins.int"><span class="n">num_features</span></a><span class="p">,</span> <span class="mi">128</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str"><span class="n">device</span></a><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="defining-the-score-predictor-for-edges">
<h2>Defining the Score Predictor for Edges<a class="headerlink" href="#defining-the-score-predictor-for-edges" title="Link to this heading">ÔÉÅ</a></h2>
<p>After getting the node representation necessary for the minibatch, the
last thing to do is to predict the score of the edges and non-existent
edges in the sampled minibatch.</p>
<p>The following score predictor, copied from the <a class="reference internal" href="../blitz/4_link_predict.html"><span class="doc">link prediction
tutorial</span></a>, takes a dot product between the
incident nodes‚Äô representations.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dgl.function</span> <span class="k">as</span> <span class="nn">fn</span>


<span class="k">class</span> <span class="nc">DotPredictor</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">g</span><span class="o">.</span><span class="n">local_scope</span><span class="p">():</span>
            <span class="n">g</span><span class="o">.</span><span class="n">ndata</span><span class="p">[</span><span class="s2">"h"</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span>
            <span class="c1"># Compute a new edge feature named 'score' by a dot-product between the</span>
            <span class="c1"># source node feature 'h' and destination node feature 'h'.</span>
            <span class="n">g</span><span class="o">.</span><span class="n">apply_edges</span><span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">u_dot_v</span><span class="p">(</span><span class="s2">"h"</span><span class="p">,</span> <span class="s2">"h"</span><span class="p">,</span> <span class="s2">"score"</span><span class="p">))</span>
            <span class="c1"># u_dot_v returns a 1-element vector for each edge so you need to squeeze it.</span>
            <span class="k">return</span> <span class="n">g</span><span class="o">.</span><span class="n">edata</span><span class="p">[</span><span class="s2">"score"</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</section>
<section id="evaluating-performance-with-unsupervised-learning-optional">
<h2>Evaluating Performance with Unsupervised Learning (Optional)<a class="headerlink" href="#evaluating-performance-with-unsupervised-learning-optional" title="Link to this heading">ÔÉÅ</a></h2>
<p>There are various ways to evaluate the performance of link prediction.
This tutorial follows the practice of <a class="reference external" href="https://cs.stanford.edu/people/jure/pubs/graphsage-nips17.pdf">GraphSAGE
paper</a>.
Basically, it first trains a GNN via link prediction, and get an embedding
for each node.  Then it trains a downstream classifier on top of this
embedding and compute the accuracy as an assessment of the embedding
quality.</p>
<p>To obtain the representations of all the nodes, this tutorial uses
neighbor sampling as introduced in the <a class="reference internal" href="L1_large_node_classification.html"><span class="doc">node classification
tutorial</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you would like to obtain node representations without
neighbor sampling during inference, please refer to this <a class="reference internal" href="../../guide/minibatch-inference.html#guide-minibatch-inference"><span class="std std-ref">user
guide</span></a>.</p>
</div>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">inference</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">node_features</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">())</span>

        <span class="n">sampler</span> <span class="o">=</span> <span class="n">dgl</span><span class="o">.</span><span class="n">dataloading</span><span class="o">.</span><span class="n">NeighborSampler</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>
        <span class="n">train_dataloader</span> <span class="o">=</span> <a class="sphx-glr-backref-module-typing sphx-glr-backref-type-py-class" href="https://docs.python.org/3/library/typing.html#typing.Generic" title="typing.Generic"><span class="n">dgl</span><span class="o">.</span><span class="n">dataloading</span><span class="o">.</span><span class="n">DataLoader</span></a><span class="p">(</span>
            <span class="n">graph</span><span class="p">,</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">()),</span>
            <span class="n">sampler</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="mi">1024</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">drop_last</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str"><span class="n">device</span></a><span class="o">=</span><a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str"><span class="n">device</span></a><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">input_nodes</span><span class="p">,</span> <span class="n">output_nodes</span><span class="p">,</span> <a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list"><span class="n">mfgs</span></a> <span class="ow">in</span> <span class="n">train_dataloader</span><span class="p">:</span>
            <span class="c1"># feature copy from CPU to GPU takes place here</span>
            <span class="n">inputs</span> <span class="o">=</span> <a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list"><span class="n">mfgs</span></a><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">srcdata</span><span class="p">[</span><span class="s2">"feat"</span><span class="p">]</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">model</span><span class="p">(</span><a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list"><span class="n">mfgs</span></a><span class="p">,</span> <span class="n">inputs</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>


<span class="kn">import</span> <span class="nn">sklearn.metrics</span>


<span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">emb</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">train_nids</span><span class="p">,</span> <span class="n">valid_nids</span><span class="p">,</span> <span class="n">test_nids</span><span class="p">):</span>
    <span class="n">classifier</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">emb</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/functions.html#int" title="builtins.int"><span class="n">num_classes</span></a><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str"><span class="n">device</span></a><span class="p">)</span>
    <span class="n">opt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">LBFGS</span><span class="p">(</span><span class="n">classifier</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">compute_loss</span><span class="p">():</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">classifier</span><span class="p">(</span><span class="n">emb</span><span class="p">[</span><span class="n">train_nids</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str"><span class="n">device</span></a><span class="p">))</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="n">label</span><span class="p">[</span><span class="n">train_nids</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str"><span class="n">device</span></a><span class="p">))</span>
        <span class="k">return</span> <span class="n">loss</span>

    <span class="k">def</span> <span class="nf">closure</span><span class="p">():</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">compute_loss</span><span class="p">()</span>
        <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">loss</span>

    <span class="n">prev_loss</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="s2">"inf"</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">):</span>
        <span class="n">opt</span><span class="o">.</span><a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/functions.html#int" title="builtins.int"><span class="n">step</span></a><span class="p">(</span><span class="n">closure</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">compute_loss</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
            <span class="k">if</span> <a class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://numpy.org/doc/stable/reference/generated/numpy.ufunc.html#numpy.ufunc" title="numpy.ufunc"><span class="n">np</span><span class="o">.</span><span class="n">abs</span></a><span class="p">(</span><span class="n">loss</span> <span class="o">-</span> <span class="n">prev_loss</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-4</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">"Converges at iteration"</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">prev_loss</span> <span class="o">=</span> <span class="n">loss</span>

    <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="n">pred</span> <span class="o">=</span> <span class="n">classifier</span><span class="p">(</span><span class="n">emb</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str"><span class="n">device</span></a><span class="p">))</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">label</span>
        <a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/functions.html#float" title="builtins.float"><span class="n">valid_acc</span></a> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">accuracy_score</span><span class="p">(</span>
            <span class="n">label</span><span class="p">[</span><span class="n">valid_nids</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">pred</span><span class="p">[</span><span class="n">valid_nids</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
        <a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/functions.html#float" title="builtins.float"><span class="n">test_acc</span></a> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">accuracy_score</span><span class="p">(</span>
            <span class="n">label</span><span class="p">[</span><span class="n">test_nids</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">pred</span><span class="p">[</span><span class="n">test_nids</span><span class="p">]</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="k">return</span> <a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/functions.html#float" title="builtins.float"><span class="n">valid_acc</span></a><span class="p">,</span> <a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/functions.html#float" title="builtins.float"><span class="n">test_acc</span></a>
</pre></div>
</div>
</section>
<section id="defining-training-loop">
<h2>Defining Training Loop<a class="headerlink" href="#defining-training-loop" title="Link to this heading">ÔÉÅ</a></h2>
<p>The following initializes the model and defines the optimizer.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">node_features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">128</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str"><span class="n">device</span></a><span class="p">)</span>
<span class="n">predictor</span> <span class="o">=</span> <span class="n">DotPredictor</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str"><span class="n">device</span></a><span class="p">)</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">Adam</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">predictor</span><span class="o">.</span><span class="n">parameters</span><span class="p">()))</span>


<span class="kn">import</span> <span class="nn">sklearn.metrics</span>
</pre></div>
</div>
<p>The following is the training loop for link prediction and
evaluation, and also saves the model that performs the best on the
validation set:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tqdm</span>

<a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/functions.html#float" title="builtins.float"><span class="n">best_accuracy</span></a> <span class="o">=</span> <span class="mi">0</span>
<a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str"><span class="n">best_model_path</span></a> <span class="o">=</span> <span class="s2">"model.pt"</span>
<span class="k">for</span> <a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/functions.html#int" title="builtins.int"><span class="n">epoch</span></a> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">train_dataloader</span><span class="p">)</span> <span class="k">as</span> <span class="n">tq</span><span class="p">:</span>
        <span class="k">for</span> <a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/functions.html#int" title="builtins.int"><span class="n">step</span></a><span class="p">,</span> <span class="p">(</span><span class="n">input_nodes</span><span class="p">,</span> <span class="n">pos_graph</span><span class="p">,</span> <span class="n">neg_graph</span><span class="p">,</span> <a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list"><span class="n">mfgs</span></a><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tq</span><span class="p">):</span>
            <span class="c1"># feature copy from CPU to GPU takes place here</span>
            <span class="n">inputs</span> <span class="o">=</span> <a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list"><span class="n">mfgs</span></a><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">srcdata</span><span class="p">[</span><span class="s2">"feat"</span><span class="p">]</span>

            <span class="n">outputs</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/stdtypes.html#list" title="builtins.list"><span class="n">mfgs</span></a><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
            <span class="n">pos_score</span> <span class="o">=</span> <span class="n">predictor</span><span class="p">(</span><span class="n">pos_graph</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>
            <span class="n">neg_score</span> <span class="o">=</span> <span class="n">predictor</span><span class="p">(</span><span class="n">neg_graph</span><span class="p">,</span> <span class="n">outputs</span><span class="p">)</span>

            <span class="n">score</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">pos_score</span><span class="p">,</span> <span class="n">neg_score</span><span class="p">])</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
                <span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">pos_score</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">neg_score</span><span class="p">)]</span>
            <span class="p">)</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">binary_cross_entropy_with_logits</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>

            <span class="n">opt</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
            <span class="n">opt</span><span class="o">.</span><a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/functions.html#int" title="builtins.int"><span class="n">step</span></a><span class="p">()</span>

            <span class="n">tq</span><span class="o">.</span><span class="n">set_postfix</span><span class="p">({</span><span class="s2">"loss"</span><span class="p">:</span> <span class="s2">"</span><span class="si">%.03f</span><span class="s2">"</span> <span class="o">%</span> <span class="n">loss</span><span class="o">.</span><span class="n">item</span><span class="p">()},</span> <span class="n">refresh</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span><a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/functions.html#int" title="builtins.int"><span class="n">step</span></a> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">500</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
                <span class="n">emb</span> <span class="o">=</span> <span class="n">inference</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">node_features</span><span class="p">)</span>
                <a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/functions.html#float" title="builtins.float"><span class="n">valid_acc</span></a><span class="p">,</span> <a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/functions.html#float" title="builtins.float"><span class="n">test_acc</span></a> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span>
                    <span class="n">emb</span><span class="p">,</span> <span class="n">node_labels</span><span class="p">,</span> <span class="n">train_nids</span><span class="p">,</span> <span class="n">valid_nids</span><span class="p">,</span> <span class="n">test_nids</span>
                <span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">"Epoch </span><span class="si">{}</span><span class="s2"> Validation Accuracy </span><span class="si">{}</span><span class="s2"> Test Accuracy </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/functions.html#int" title="builtins.int"><span class="n">epoch</span></a><span class="p">,</span> <a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/functions.html#float" title="builtins.float"><span class="n">valid_acc</span></a><span class="p">,</span> <a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/functions.html#float" title="builtins.float"><span class="n">test_acc</span></a>
                    <span class="p">)</span>
                <span class="p">)</span>
                <span class="k">if</span> <a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/functions.html#float" title="builtins.float"><span class="n">best_accuracy</span></a> <span class="o">&lt;</span> <a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/functions.html#float" title="builtins.float"><span class="n">valid_acc</span></a><span class="p">:</span>
                    <a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/functions.html#float" title="builtins.float"><span class="n">best_accuracy</span></a> <span class="o">=</span> <a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/functions.html#float" title="builtins.float"><span class="n">valid_acc</span></a>
                    <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span> <a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/stdtypes.html#str" title="builtins.str"><span class="n">best_model_path</span></a><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">()</span>

                <span class="c1"># Note that this tutorial do not train the whole model to the end.</span>
                <span class="k">break</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>  0%|          | 0/2278 [00:00&lt;?, ?it/s]
  0%|          | 2/2278 [00:00&lt;02:14, 16.92it/s, loss=31.168]
  0%|          | 6/2278 [00:00&lt;01:17, 29.39it/s, loss=8.414]
  0%|          | 10/2278 [00:00&lt;01:09, 32.64it/s, loss=2.298]
  1%|          | 14/2278 [00:00&lt;01:05, 34.74it/s, loss=1.365]
  1%|          | 19/2278 [00:00&lt;01:00, 37.07it/s, loss=1.018]
  1%|          | 23/2278 [00:00&lt;00:59, 37.65it/s, loss=0.901]
  1%|          | 28/2278 [00:00&lt;00:57, 38.92it/s, loss=0.829]
  1%|‚ñè         | 32/2278 [00:00&lt;00:57, 38.98it/s, loss=0.799]
  2%|‚ñè         | 37/2278 [00:01&lt;00:55, 40.15it/s, loss=0.760]
  2%|‚ñè         | 42/2278 [00:01&lt;00:56, 39.69it/s, loss=0.747]
  2%|‚ñè         | 46/2278 [00:01&lt;00:57, 38.71it/s, loss=0.724]
  2%|‚ñè         | 50/2278 [00:01&lt;00:59, 37.73it/s, loss=0.720]
  2%|‚ñè         | 54/2278 [00:01&lt;00:59, 37.50it/s, loss=0.703]
  3%|‚ñé         | 59/2278 [00:01&lt;00:57, 38.89it/s, loss=0.691]
  3%|‚ñé         | 63/2278 [00:01&lt;00:57, 38.85it/s, loss=0.685]
  3%|‚ñé         | 68/2278 [00:01&lt;00:55, 39.76it/s, loss=0.685]
  3%|‚ñé         | 73/2278 [00:01&lt;00:55, 39.58it/s, loss=0.682]
  3%|‚ñé         | 77/2278 [00:02&lt;00:55, 39.34it/s, loss=0.680]
  4%|‚ñé         | 81/2278 [00:02&lt;00:56, 38.90it/s, loss=0.683]
  4%|‚ñç         | 86/2278 [00:02&lt;00:55, 39.76it/s, loss=0.678]
  4%|‚ñç         | 90/2278 [00:02&lt;00:56, 39.06it/s, loss=0.678]
  4%|‚ñç         | 94/2278 [00:02&lt;00:55, 39.26it/s, loss=0.681]
  4%|‚ñç         | 98/2278 [00:02&lt;00:55, 38.93it/s, loss=0.679]
  4%|‚ñç         | 102/2278 [00:02&lt;00:55, 38.93it/s, loss=0.673]
  5%|‚ñç         | 106/2278 [00:02&lt;00:55, 39.05it/s, loss=0.671]
  5%|‚ñç         | 110/2278 [00:02&lt;00:55, 39.15it/s, loss=0.680]
  5%|‚ñå         | 114/2278 [00:02&lt;00:55, 39.22it/s, loss=0.669]
  5%|‚ñå         | 118/2278 [00:03&lt;00:54, 39.30it/s, loss=0.670]
  5%|‚ñå         | 122/2278 [00:03&lt;00:56, 38.37it/s, loss=0.671]
  6%|‚ñå         | 127/2278 [00:03&lt;00:55, 38.86it/s, loss=0.668]
  6%|‚ñå         | 131/2278 [00:03&lt;00:56, 37.98it/s, loss=0.670]
  6%|‚ñå         | 136/2278 [00:03&lt;00:54, 39.16it/s, loss=0.667]
  6%|‚ñå         | 140/2278 [00:03&lt;00:54, 39.25it/s, loss=0.675]
  6%|‚ñã         | 145/2278 [00:03&lt;00:53, 40.10it/s, loss=0.667]
  7%|‚ñã         | 150/2278 [00:03&lt;00:53, 39.94it/s, loss=0.670]
  7%|‚ñã         | 154/2278 [00:03&lt;00:53, 39.88it/s, loss=0.672]
  7%|‚ñã         | 159/2278 [00:04&lt;00:52, 40.62it/s, loss=0.670]
  7%|‚ñã         | 164/2278 [00:04&lt;00:52, 40.33it/s, loss=0.670]
  7%|‚ñã         | 169/2278 [00:04&lt;00:53, 39.58it/s, loss=0.671]
  8%|‚ñä         | 174/2278 [00:04&lt;00:52, 40.19it/s, loss=0.669]
  8%|‚ñä         | 179/2278 [00:04&lt;00:51, 40.79it/s, loss=0.670]
  8%|‚ñä         | 184/2278 [00:04&lt;00:51, 40.82it/s, loss=0.665]
  8%|‚ñä         | 189/2278 [00:04&lt;00:50, 40.97it/s, loss=0.668]
  9%|‚ñä         | 194/2278 [00:04&lt;00:50, 41.44it/s, loss=0.672]
  9%|‚ñä         | 199/2278 [00:05&lt;00:51, 40.63it/s, loss=0.663]
  9%|‚ñâ         | 204/2278 [00:05&lt;00:50, 41.26it/s, loss=0.672]
  9%|‚ñâ         | 209/2278 [00:05&lt;00:50, 40.63it/s, loss=0.663]
  9%|‚ñâ         | 214/2278 [00:05&lt;00:50, 40.61it/s, loss=0.667]
 10%|‚ñâ         | 219/2278 [00:05&lt;00:54, 37.91it/s, loss=0.673]
 10%|‚ñâ         | 224/2278 [00:05&lt;00:52, 38.92it/s, loss=0.669]
 10%|‚ñà         | 229/2278 [00:05&lt;00:51, 39.98it/s, loss=0.668]
 10%|‚ñà         | 234/2278 [00:05&lt;00:51, 39.86it/s, loss=0.669]
 10%|‚ñà         | 239/2278 [00:06&lt;00:50, 39.98it/s, loss=0.663]
 11%|‚ñà         | 244/2278 [00:06&lt;00:51, 39.37it/s, loss=0.662]
 11%|‚ñà         | 248/2278 [00:06&lt;00:53, 37.90it/s, loss=0.667]
 11%|‚ñà         | 252/2278 [00:06&lt;00:53, 37.58it/s, loss=0.666]
 11%|‚ñà         | 256/2278 [00:06&lt;00:53, 38.04it/s, loss=0.668]
 11%|‚ñà‚ñè        | 260/2278 [00:06&lt;00:53, 37.75it/s, loss=0.663]
 12%|‚ñà‚ñè        | 265/2278 [00:06&lt;00:51, 39.15it/s, loss=0.667]
 12%|‚ñà‚ñè        | 270/2278 [00:06&lt;00:49, 40.19it/s, loss=0.663]
 12%|‚ñà‚ñè        | 275/2278 [00:07&lt;00:48, 40.98it/s, loss=0.666]
 12%|‚ñà‚ñè        | 280/2278 [00:07&lt;00:49, 40.13it/s, loss=0.669]
 13%|‚ñà‚ñé        | 285/2278 [00:07&lt;00:50, 39.81it/s, loss=0.665]
 13%|‚ñà‚ñé        | 289/2278 [00:07&lt;00:50, 39.40it/s, loss=0.663]
 13%|‚ñà‚ñé        | 293/2278 [00:07&lt;00:50, 39.21it/s, loss=0.658]
 13%|‚ñà‚ñé        | 297/2278 [00:07&lt;00:50, 38.97it/s, loss=0.661]
 13%|‚ñà‚ñé        | 301/2278 [00:07&lt;00:50, 39.22it/s, loss=0.664]
 13%|‚ñà‚ñé        | 305/2278 [00:07&lt;00:50, 39.44it/s, loss=0.659]
 14%|‚ñà‚ñé        | 310/2278 [00:07&lt;00:48, 40.33it/s, loss=0.663]
 14%|‚ñà‚ñç        | 315/2278 [00:08&lt;00:47, 40.93it/s, loss=0.661]
 14%|‚ñà‚ñç        | 320/2278 [00:08&lt;00:48, 40.03it/s, loss=0.658]
 14%|‚ñà‚ñç        | 325/2278 [00:08&lt;00:49, 39.31it/s, loss=0.661]
 14%|‚ñà‚ñç        | 329/2278 [00:08&lt;00:50, 38.55it/s, loss=0.661]
 15%|‚ñà‚ñç        | 333/2278 [00:08&lt;00:52, 37.36it/s, loss=0.660]
 15%|‚ñà‚ñç        | 337/2278 [00:08&lt;00:52, 36.95it/s, loss=0.655]
 15%|‚ñà‚ñç        | 341/2278 [00:08&lt;00:51, 37.68it/s, loss=0.659]
 15%|‚ñà‚ñå        | 346/2278 [00:08&lt;00:49, 39.25it/s, loss=0.668]
 15%|‚ñà‚ñå        | 351/2278 [00:08&lt;00:48, 40.12it/s, loss=0.666]
 16%|‚ñà‚ñå        | 356/2278 [00:09&lt;00:48, 39.95it/s, loss=0.664]
 16%|‚ñà‚ñå        | 360/2278 [00:09&lt;00:49, 38.61it/s, loss=0.662]
 16%|‚ñà‚ñå        | 364/2278 [00:09&lt;00:49, 38.94it/s, loss=0.661]
 16%|‚ñà‚ñå        | 368/2278 [00:09&lt;00:48, 39.21it/s, loss=0.665]
 16%|‚ñà‚ñã        | 372/2278 [00:09&lt;00:49, 38.62it/s, loss=0.662]
 17%|‚ñà‚ñã        | 376/2278 [00:09&lt;00:48, 38.99it/s, loss=0.665]
 17%|‚ñà‚ñã        | 380/2278 [00:09&lt;00:48, 39.05it/s, loss=0.660]
 17%|‚ñà‚ñã        | 384/2278 [00:09&lt;00:48, 39.10it/s, loss=0.659]
 17%|‚ñà‚ñã        | 388/2278 [00:09&lt;00:48, 39.16it/s, loss=0.663]
 17%|‚ñà‚ñã        | 393/2278 [00:10&lt;00:46, 40.25it/s, loss=0.657]
 17%|‚ñà‚ñã        | 398/2278 [00:10&lt;00:47, 39.94it/s, loss=0.661]
 18%|‚ñà‚ñä        | 402/2278 [00:10&lt;00:47, 39.58it/s, loss=0.657]
 18%|‚ñà‚ñä        | 407/2278 [00:10&lt;00:46, 40.11it/s, loss=0.666]
 18%|‚ñà‚ñä        | 412/2278 [00:10&lt;00:45, 40.63it/s, loss=0.656]
 18%|‚ñà‚ñä        | 417/2278 [00:10&lt;00:46, 40.44it/s, loss=0.666]
 19%|‚ñà‚ñä        | 422/2278 [00:10&lt;00:47, 39.28it/s, loss=0.658]
 19%|‚ñà‚ñä        | 427/2278 [00:10&lt;00:46, 39.66it/s, loss=0.660]
 19%|‚ñà‚ñâ        | 432/2278 [00:11&lt;00:45, 40.33it/s, loss=0.656]
 19%|‚ñà‚ñâ        | 437/2278 [00:11&lt;00:45, 40.20it/s, loss=0.658]
 19%|‚ñà‚ñâ        | 442/2278 [00:11&lt;00:45, 40.27it/s, loss=0.659]
 20%|‚ñà‚ñâ        | 447/2278 [00:11&lt;00:45, 40.08it/s, loss=0.654]
 20%|‚ñà‚ñâ        | 452/2278 [00:11&lt;00:46, 39.17it/s, loss=0.663]
 20%|‚ñà‚ñà        | 456/2278 [00:11&lt;00:46, 39.21it/s, loss=0.662]
 20%|‚ñà‚ñà        | 460/2278 [00:11&lt;00:46, 39.21it/s, loss=0.656]
 20%|‚ñà‚ñà        | 465/2278 [00:11&lt;00:45, 40.05it/s, loss=0.657]
 21%|‚ñà‚ñà        | 470/2278 [00:11&lt;00:44, 40.73it/s, loss=0.658]
 21%|‚ñà‚ñà        | 475/2278 [00:12&lt;00:43, 41.35it/s, loss=0.655]
 21%|‚ñà‚ñà        | 480/2278 [00:12&lt;00:44, 40.32it/s, loss=0.657]
 21%|‚ñà‚ñà‚ñè       | 485/2278 [00:12&lt;00:46, 38.89it/s, loss=0.664]
 22%|‚ñà‚ñà‚ñè       | 490/2278 [00:12&lt;00:45, 39.20it/s, loss=0.662]
 22%|‚ñà‚ñà‚ñè       | 494/2278 [00:12&lt;00:45, 38.82it/s, loss=0.658]
 22%|‚ñà‚ñà‚ñè       | 499/2278 [00:12&lt;00:44, 39.79it/s, loss=0.658]Converges at iteration 10
Epoch 0 Validation Accuracy 0.07762005436424041 Test Accuracy 0.05929675122934798

 22%|‚ñà‚ñà‚ñè       | 499/2278 [00:18&lt;01:06, 26.68it/s, loss=0.661]
</pre></div>
</div>
</section>
<section id="evaluating-performance-with-link-prediction-optional">
<h2>Evaluating Performance with Link Prediction (Optional)<a class="headerlink" href="#evaluating-performance-with-link-prediction-optional" title="Link to this heading">ÔÉÅ</a></h2>
<p>In practice, it is more common to evaluate the link prediction
model to see whether it can predict new edges. There are different
evaluation metrics such as
<a class="reference external" href="https://en.wikipedia.org/wiki/Receiver_operating_characteristic#Area_under_the_curve">AUC</a>
or <a class="reference external" href="https://en.wikipedia.org/wiki/Evaluation_measures_(information_retrieval)">various metrics from information retrieval</a>.
Ultimately, they require the model to predict one scalar score given
a node pair among a set of node pairs.</p>
<p>Assuming that you have the following test set with labels, where
<code class="docutils literal notranslate"><span class="pre">test_pos_src</span></code> and <code class="docutils literal notranslate"><span class="pre">test_pos_dst</span></code> are ground truth node pairs
with edges in between (or <em>positive</em> pairs), and <code class="docutils literal notranslate"><span class="pre">test_neg_src</span></code>
and <code class="docutils literal notranslate"><span class="pre">test_neg_dst</span></code> are ground truth node pairs without edges
in between (or <em>negative</em> pairs).</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Positive pairs</span>
<span class="c1"># These are randomly generated as an example.  You will need to</span>
<span class="c1"># replace them with your own ground truth.</span>
<a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/functions.html#int" title="builtins.int"><span class="n">n_test_pos</span></a> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">test_pos_src</span><span class="p">,</span> <span class="n">test_pos_dst</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">graph</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">(),</span> <span class="p">(</span><a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/functions.html#int" title="builtins.int"><span class="n">n_test_pos</span></a><span class="p">,)),</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">graph</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">(),</span> <span class="p">(</span><a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/functions.html#int" title="builtins.int"><span class="n">n_test_pos</span></a><span class="p">,)),</span>
<span class="p">)</span>
<span class="c1"># Negative pairs.  Likewise, you will need to replace them with your</span>
<span class="c1"># own ground truth.</span>
<span class="n">test_neg_src</span> <span class="o">=</span> <span class="n">test_pos_src</span>
<span class="n">test_neg_dst</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">graph</span><span class="o">.</span><span class="n">num_nodes</span><span class="p">(),</span> <span class="p">(</span><a class="sphx-glr-backref-module-builtins sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://docs.python.org/3/library/functions.html#int" title="builtins.int"><span class="n">n_test_pos</span></a><span class="p">,))</span>
</pre></div>
</div>
<p>First you need to compute the node representations for all the nodes
with the <code class="docutils literal notranslate"><span class="pre">inference</span></code> method above:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">node_reprs</span> <span class="o">=</span> <span class="n">inference</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">node_features</span><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>/home/ubuntu/regression_test/dgl/python/dgl/dataloading/dataloader.py:1149: DGLWarning: Dataloader CPU affinity opt is not enabled, consider switching it on (see enable_cpu_affinity() or CPU best practices for DGL [https://docs.dgl.ai/tutorials/cpu/cpu_best_practises.html])
  dgl_warning(
</pre></div>
</div>
<p>Since the predictor is a dot product, you can now easily compute the
score of positive and negative test pairs to compute metrics such
as AUC:</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="n">h_pos_src</span> <span class="o">=</span> <span class="n">node_reprs</span><span class="p">[</span><span class="n">test_pos_src</span><span class="p">]</span>
<span class="n">h_pos_dst</span> <span class="o">=</span> <span class="n">node_reprs</span><span class="p">[</span><span class="n">test_pos_dst</span><span class="p">]</span>
<span class="n">h_neg_src</span> <span class="o">=</span> <span class="n">node_reprs</span><span class="p">[</span><span class="n">test_neg_src</span><span class="p">]</span>
<span class="n">h_neg_dst</span> <span class="o">=</span> <span class="n">node_reprs</span><span class="p">[</span><span class="n">test_neg_dst</span><span class="p">]</span>
<span class="n">score_pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_pos_src</span> <span class="o">*</span> <span class="n">h_pos_dst</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">score_neg</span> <span class="o">=</span> <span class="p">(</span><span class="n">h_neg_src</span> <span class="o">*</span> <span class="n">h_neg_dst</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray"><span class="n">test_preds</span></a> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">score_pos</span><span class="p">,</span> <span class="n">score_neg</span><span class="p">])</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<a class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray"><span class="n">test_labels</span></a> <span class="o">=</span> <span class="p">(</span>
    <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">torch</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">score_pos</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">score_neg</span><span class="p">)])</span>
    <span class="o">.</span><span class="n">cpu</span><span class="p">()</span>
    <span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="p">)</span>

<a class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-attribute" href="https://numpy.org/doc/stable/reference/arrays.scalars.html#numpy.float64" title="numpy.float64"><span class="n">auc</span></a> <span class="o">=</span> <span class="n">sklearn</span><span class="o">.</span><span class="n">metrics</span><span class="o">.</span><span class="n">roc_auc_score</span><span class="p">(</span><a class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray"><span class="n">test_labels</span></a><span class="p">,</span> <a class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-class sphx-glr-backref-instance" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.html#numpy.ndarray" title="numpy.ndarray"><span class="n">test_preds</span></a><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Link Prediction AUC:"</span><span class="p">,</span> <a class="sphx-glr-backref-module-numpy sphx-glr-backref-type-py-attribute" href="https://numpy.org/doc/stable/reference/arrays.scalars.html#numpy.float64" title="numpy.float64"><span class="n">auc</span></a><span class="p">)</span>
</pre></div>
</div>
<div class="sphx-glr-script-out highlight-none notranslate"><div class="highlight"><pre><span></span>Link Prediction AUC: 0.496437
</pre></div>
</div>
</section>
<section id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Link to this heading">ÔÉÅ</a></h2>
<p>In this tutorial, you have learned how to train a multi-layer GraphSAGE
for link prediction with neighbor sampling.</p>
<div class="highlight-Python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Thumbnail credits: Link Prediction with Neo4j, Mark Needham</span>
<span class="c1"># sphinx_gallery_thumbnail_path = '_static/blitz_4_link_predict.png'</span>
</pre></div>
</div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> (0 minutes 21.171 seconds)</p>
<div class="sphx-glr-footer sphx-glr-footer-example docutils container" id="sphx-glr-download-tutorials-large-l2-large-link-prediction-py">
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/e6f5a1a75dd013e69f7b7f95463ba374/L2_large_link_prediction.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">L2_large_link_prediction.ipynb</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/33161faadbe6125864100658b0e6157b/L2_large_link_prediction.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">L2_large_link_prediction.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-zip docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/6c0d9d562b2dd77747f123c4408050d5/L2_large_link_prediction.zip"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">zipped:</span> <span class="pre">L2_large_link_prediction.zip</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</section>
</section>
</div>
</div>
<footer><div aria-label="Footer" class="rst-footer-buttons" role="navigation">
<a accesskey="p" class="btn btn-neutral float-left" href="L1_large_node_classification.html" rel="prev" title="Training GNN with Neighbor Sampling for Node Classification"><span aria-hidden="true" class="fa fa-arrow-circle-left"></span> Previous</a>
<a accesskey="n" class="btn btn-neutral float-right" href="L4_message_passing.html" rel="next" title="Writing GNN Modules for Stochastic GNN Training">Next <span aria-hidden="true" class="fa fa-arrow-circle-right"></span></a>
</div>
<hr/>
<div role="contentinfo">
<p>¬© Copyright 2018, DGL Team.</p>
</div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
</div>
</div>
</section>
</div>
<div aria-label="Versions" class="rst-versions" data-toggle="rst-versions" role="note">
<span class="rst-current-version" data-toggle="rst-current-version">
<span class="fa fa-book"> Read the Docs</span>
<span id="version-placeholder">v: latest</span>
<span class="fa fa-caret-down"></span>
</span>
<div class="rst-other-versions">
<dl>
<dt>Versions</dt>
<div id="version-list">
<!-- Âä®ÊÄÅÊèíÂÖ•ÁöÑÁâàÊú¨ÂàóË°®Â∞ÜÂá∫Áé∞Âú®ËøôÈáå -->
</div>
</dl>
<dl>
<dt>Downloads</dt>
<!-- ‰∏ãËΩΩÂÜÖÂÆπ -->
</dl>
<dl>
<dt>On Read the Docs</dt>
<dd><a href="//doc-build.dgl.ai/projects/dgl/?fromdocs=dgl">Project Home</a></dd>
<dd><a href="//doc-build.dgl.ai/builds/dgl/?fromdocs=dgl">Builds</a></dd>
</dl>
</div>
</div>
<script>
        document.addEventListener("DOMContentLoaded", function() {
            fetch('/dgl_docs/branches.json')
                .then(response => response.json())
                .then(data => {
                    var versionListDiv = document.getElementById('version-list');
                    data.branches.forEach(function(branch) {
                        var dd = document.createElement('dd');
                        var a = document.createElement('a');
                        a.href = branch.url;
                        a.textContent = branch.name;
                        dd.appendChild(a);
                        versionListDiv.appendChild(dd);
                    });
                })
                .catch(error => console.error('Error loading branches:', error));
        });
        document.addEventListener("DOMContentLoaded", function() {
            // Ëé∑ÂèñÂΩìÂâçË∑ØÂæÑ
            var path = window.location.pathname;
            var versionPlaceholder = document.getElementById('version-placeholder');

            // Ê£ÄÊü•Ë∑ØÂæÑ‰∏≠ÊòØÂê¶ÂåÖÂê´ 'en'
            if (path.includes('/en/')) {
                // ÊèêÂèñ 'en' ÂêéÁöÑÊñá‰ª∂Â§π‰Ωú‰∏∫ÁâàÊú¨Âè∑
                var parts = path.split('/en/');
                if (parts[1]) {
                    var folders = parts[1].split('/');
                    if (folders.length > 0 && folders[0]) {
                        versionPlaceholder.textContent = 'v: ' + folders[0];
                    } else {
                        versionPlaceholder.textContent = 'v: latest';
                    }
                } else {
                    versionPlaceholder.textContent = 'v: latest';
                }
            } else {
                versionPlaceholder.textContent = 'v: latest';
            }
        });
    </script>

<script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
</body>
</html>